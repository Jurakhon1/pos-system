# Интеграция API для обработки платежей и отмены заказов

## Обзор

Данный документ описывает интеграцию с API для обработки платежей и отмены заказов в POS системе.

## API Endpoints

### 1. Обработка платежа

**POST** `/orders/{id}/payment`

Обрабатывает платеж по заказу.

#### Параметры запроса:
```typescript
{
  paymentMethod: 'cash' | 'card' | 'mixed';
  cashAmount?: number;      // Сумма наличными (для cash и mixed)
  cardAmount?: number;      // Сумма картой (для card и mixed)
  discountAmount: number;   // Размер скидки (всегда отправляется)
}
```

**⚠️ Важно:** Все числовые поля должны быть в формате decimal (например: 460.00, а не 460).

#### Примеры запросов:

**Оплата наличными:**
```json
{
  "paymentMethod": "cash",
  "cashAmount": 1500.00,
  "discountAmount": 100.00
}
```

**Оплата картой:**
```json
{
  "paymentMethod": "card",
  "cardAmount": 1400.00,
  "discountAmount": 0.00
}
```

**Смешанная оплата:**
```json
{
  "paymentMethod": "mixed",
  "cashAmount": 500.00,
  "cardAmount": 900.00,
  "discountAmount": 100.00
}
```

#### Заголовки:
```
Authorization: Bearer YOUR_JWT_TOKEN_HERE
Content-Type: application/json
```

### 2. Отмена заказа

**PUT** `/orders/{id}/cancel`

Отменяет заказ.

#### Параметры запроса:
Отсутствуют (только ID заказа в URL)

#### Заголовки:
```
Authorization: Bearer YOUR_JWT_TOKEN_HERE
```

## Типы данных

### PaymentRequest
```typescript
export interface PaymentRequest {
  paymentMethod: 'cash' | 'card' | 'mixed';
  cashAmount?: number;      // Должно быть decimal (например: 460.00)
  cardAmount?: number;      // Должно быть decimal (например: 460.00)
  discountAmount: number;   // Всегда отправляется, даже если 0 (например: 0.00)
}
```

### PaymentResponse
```typescript
export interface PaymentResponse {
  success: boolean;
  message: string;
  orderId: string;
  paymentId?: string;
  totalPaid: number;
  change?: number;
}
```

## Решение проблем валидации

### Проблема: "isDecimal" validation error
Бэкенд ожидает все числовые поля в формате decimal. Если отправлять целые числа (например, 460 вместо 460.00), возникает ошибка валидации.

#### Решение:
1. **Форматирование чисел**: Все числовые значения округляются до 2 знаков после запятой
2. **Обязательное поле discountAmount**: Поле всегда отправляется, даже если скидка равна 0
3. **Валидация на клиенте**: Проверка корректности формата перед отправкой

#### Код решения:
```typescript
// Функция для форматирования чисел как decimal
const formatAsDecimal = (value: string | number): number => {
  const num = Number(value) || 0;
  // Округляем до 2 знаков после запятой для корректного decimal формата
  return Math.round(num * 100) / 100;
};

// Применение в handleSubmit
let paymentData: PaymentRequest = { 
  paymentMethod,
  discountAmount: formatAsDecimal(discountAmount)
};

if (paymentMethod === 'cash') {
  paymentData.cashAmount = formatAsDecimal(cashAmount || finalTotal);
} else if (paymentMethod === 'card') {
  paymentData.cardAmount = formatAsDecimal(cardAmount || finalTotal);
}
```

## Интеграция в Frontend

### Компоненты

#### PaymentModal
Модальное окно для обработки платежей с возможностями:
- Выбор способа оплаты (наличные, карта, смешанная)
- Ввод суммы скидки
- Ввод сумм по способам оплаты
- Валидация сумм для смешанной оплаты
- Автоматический расчет итоговой суммы
- **Автоматическое форматирование чисел в decimal формат**

#### Toast уведомления
Система уведомлений для информирования пользователя:
- **Успех** - зеленые уведомления для успешных операций
- **Ошибка** - красные уведомления для ошибок
- **Предупреждение** - желтые уведомления для предупреждений
- **Информация** - синие уведомления для информационных сообщений

#### Кнопки действий
- **Оплатить** - открывает модальное окно оплаты
- **Отменить** - отменяет заказ с подтверждением
- **Удалить** - удаляет заказ (существующая функциональность)

### Хуки

#### useOrders
Предоставляет функции:
- `processPayment(orderId, paymentData)` - обработка платежа
- `cancelOrder(orderId)` - отмена заказа
- Состояния загрузки: `isProcessingPayment`, `isCancelling`

### API слой

#### OrdersApi
```typescript
// Обработка платежа
processPayment: async (orderId: string, paymentData: PaymentRequest): Promise<PaymentResponse> => {
  const response = await api.post(`/orders/${orderId}/payment`, paymentData);
  return response.data;
}

// Отмена заказа
cancelOrder: async (orderId: string) => {
  const response = await api.put(`/orders/${orderId}/cancel`);
  return response.data;
}
```

## Логика работы

### Обработка платежа

1. **Валидация статуса заказа**
   - Кнопка оплаты отображается только для заказов со статусами: `pending`, `confirmed`, `cooking`, `ready`, `served`
   - Не отображается для заказов со статусами: `paid`, `cancelled`

2. **Выбор способа оплаты**
   - **Наличные**: ввод суммы наличными (по умолчанию = итоговая сумма)
   - **Карта**: ввод суммы картой (по умолчанию = итоговая сумма)
   - **Смешанная**: ввод сумм по обоим способам с валидацией

3. **Расчет скидки**
   - Ввод размера скидки в рублях
   - Автоматический пересчет итоговой суммы

4. **Валидация и форматирование**
   - Для смешанной оплаты: сумма наличными + сумма картой ≥ итоговая сумма
   - Скидка не может превышать общую сумму заказа
   - **Все числовые значения автоматически форматируются в decimal формат**

### Отмена заказа

1. **Валидация статуса**
   - Кнопка отмены отображается только для заказов со статусами: `pending`, `confirmed`, `cooking`, `ready`, `served`
   - Не отображается для заказов со статусами: `paid`, `cancelled`

2. **Подтверждение**
   - Показ диалога подтверждения перед отменой
   - Вызов API только после подтверждения

## UI/UX особенности

### Модальное окно оплаты
- **Адаптивный дизайн** - корректно отображается на всех устройствах
- **Валидация в реальном времени** - мгновенная проверка корректности сумм
- **Визуальная обратная связь** - цветовая индикация способов оплаты
- **Автозаполнение** - умные значения по умолчанию для сумм
- **Автоматическое форматирование** - все числа корректно форматируются для API

### Кнопки действий
- **Цветовая индикация** - зеленый для оплаты, красный для отмены
- **Состояния загрузки** - спиннеры и блокировка во время API вызовов
- **Условное отображение** - показ только релевантных действий

### Система уведомлений
- **Автоматическое исчезновение** - уведомления скрываются через заданное время
- **Ручное закрытие** - возможность закрыть уведомление вручную
- **Типизация** - разные стили для разных типов сообщений
- **Позиционирование** - уведомления отображаются в правом верхнем углу

### Обработка ошибок
- **Toast уведомления** - информирование об успехе/ошибке операций
- **Валидация форм** - предотвращение некорректных данных
- **Fallback состояния** - корректная обработка ошибок API
- **Автоматическое исправление** - форматирование чисел для соответствия требованиям API

## Тестирование

### Unit тесты
Созданы тесты для проверки:
- Отображения кнопок оплаты/отмены
- Открытия модального окна оплаты
- Валидации форм
- Расчетов сумм и скидок
- Обработки различных способов оплаты
- **Корректного форматирования чисел в decimal формат**

### Тестовые сценарии
1. **Оплата наличными** - проверка корректности расчета
2. **Оплата картой** - проверка валидации сумм
3. **Смешанная оплата** - проверка сложной логики
4. **Скидки** - проверка корректности расчетов
5. **Отмена заказа** - проверка подтверждения
6. **Форматирование чисел** - проверка корректности decimal формата

## Безопасность

### Валидация данных
- Проверка корректности сумм на клиенте
- Предотвращение отрицательных значений
- Валидация размеров скидок
- **Автоматическое форматирование чисел для соответствия требованиям API**

### Аутентификация
- JWT токены в заголовке Authorization
- Автоматическое обновление токенов
- Безопасная передача данных

### Обработка ошибок
- Graceful fallback при ошибках API
- Информирование пользователя о проблемах
- Логирование ошибок для отладки
- **Автоматическое исправление проблем с валидацией**

## Производительность

### Оптимизации
- **Lazy loading** модальных окон
- **Debounced** валидация форм
- **Memoized** расчеты сумм
- **Optimistic updates** для UI
- **Эффективное форматирование** чисел без лишних вычислений

### Кэширование
- Автоматическое обновление списка заказов после операций
- Инвалидация кэша при изменениях
- Эффективное управление состоянием

## Будущие улучшения

### Планируемые функции
1. **Множественные способы оплаты** - поддержка других платежных систем
2. **Автоматические скидки** - правила и промокоды
3. **Возврат средств** - обработка возвратов и частичных возвратов
4. **Аналитика платежей** - статистика и отчеты
5. **Интеграция с банками** - прямые банковские переводы

### Технические улучшения
1. **WebSocket уведомления** - реальное время обновлений
2. **Offline поддержка** - работа без интернета
3. **PWA функциональность** - установка как приложение
4. **Push уведомления** - уведомления о статусе заказов
5. **Улучшенная валидация** - более детальная проверка форматов данных

## Примеры использования

### Обработка платежа наличными
```typescript
const paymentData: PaymentRequest = {
  paymentMethod: 'cash',
  cashAmount: 1500.00,
  discountAmount: 100.00
};

await processPayment(orderId, paymentData);
```

### Обработка смешанного платежа
```typescript
const paymentData: PaymentRequest = {
  paymentMethod: 'mixed',
  cashAmount: 500.00,
  cardAmount: 900.00,
  discountAmount: 100.00
};

await processPayment(orderId, paymentData);
```

### Отмена заказа
```typescript
await cancelOrder(orderId);
```

## Решение проблем

### Ошибка валидации "isDecimal"
**Проблема:** API возвращает ошибку 400 с сообщением "isDecimal" для числовых полей.

**Причина:** Бэкенд ожидает decimal числа (например, 460.00), а получает целые числа (460).

**Решение:** 
1. Все числовые значения автоматически форматируются в decimal формат
2. Функция `formatAsDecimal` округляет числа до 2 знаков после запятой
3. Поле `discountAmount` всегда отправляется, даже если равно 0

**Пример исправления:**
```typescript
// До исправления (вызывало ошибку)
{
  "paymentMethod": "card",
  "cardAmount": 460,        // ❌ Целое число
  "discountAmount": 0       // ❌ Целое число
}

// После исправления (работает корректно)
{
  "paymentMethod": "card",
  "cardAmount": 460.00,     // ✅ Decimal число
  "discountAmount": 0.00    // ✅ Decimal число
}
```
